name: "Cover Agent CI pipeline"
description: "test"
author: "Kousik Mitra"
inputs:
  sourceDir:
    description: "Source code dir"
    required: true
  desiredCoverage:
    description: "Desired coverage"
    default: "70"
  maxIterations:
    description: "Max iterations to run to acheive desired coverage"
    default: "1"
  modelName:
    description: "Name of the model"
    required: true
  apiEndpoint:
    description: "API Endpoint to access the model"
    required: true
  githubToken:
    description: "github token"
    required: true
outputs:
  previousCoverage:
    description: "Previous coverage"
    value: ${{ steps.cover-agent-ci-action.outputs.previousCoverage }}
  currentCoverage:
    description: "Current coverage"
    value: ${{ steps.cover-agent-ci-action.outputs.currentCoverageg }}
runs:
  using: composite
  steps:
    - uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    - name: Install cover-agent
      shell: sh
      run: |
        pip install git+https://github.com/Codium-ai/cover-agent.git

    - uses: actions/setup-go@v5
      with:
        go-version: ">=1.20.0"

    - name: Install go coverage tools
      shell: sh
      run: |
        go version
        go install github.com/axw/gocov/gocov@v1.1.0
        go install github.com/AlekSi/gocov-xml@v1.1.0

    - name: Run cover-agent-ci
      id: cover-agent-ci-action
      uses: ./cover-agent-action
      with:
        sourceDir: ${{ inputs.sourceDir }}
        desiredCoverage: ${{ inputs.desiredCoverage }}
        maxIterations: ${{ inputs.maxIterations }}
        modelName: ${{ inputs.modelName }}
        apiEndpoint: ${{ inputs.apiEndpoint }}
        githubToken: ${{ inputs.githubToken }}

  # using: "node20"
  # main: "index.js"
